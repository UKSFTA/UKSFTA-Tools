#!/usr/bin/env python3
import os
import sys
import json
import subprocess
from datetime import datetime
from pathlib import Path

# UKSFTA Unit Health Report Generator
# Consolidates all audit data into a single Markdown report.

def generate_report(root_dir):
    root = Path(root_dir)
    report_path = root / "UNIT_HEALTH_REPORT.md"
    
    print("ðŸ“Š Generating Global Unit Health Report...")
    
    # 1. Fetch Dashboard Data (JSON)
    manager = root / "tools" / "workspace_manager.py"
    dash_res = subprocess.run([sys.executable, str(manager), "--json", "dashboard"], capture_output=True, text=True)
    dash_data = json.loads(dash_res.stdout) if dash_res.returncode == 0 else []

    # 2. Fetch Workshop Data (JSON)
    ws_res = subprocess.run([sys.executable, str(manager), "--json", "audit-updates"], capture_output=True, text=True)
    ws_data = json.loads(ws_res.stdout) if ws_res.returncode == 0 else []

    with open(report_path, "w") as f:
        f.write(f"# ðŸ›¡ï¸ UKSFTA Unit Health Report\n")
        f.write(f"**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
        
        f.write("## ðŸ“¦ Project Overview\n")
        f.write("| Project | Version | Components | Status |\n")
        f.write("| :--- | :--- | :--- | :--- |\n")
        for p in dash_data:
            pbos = len(p['pbos'])
            status = "âœ… OK" if p['sync_state'] == "OK" else "âš ï¸ PENDING"
            f.write(f"| {p['project']} | {p['version']} | {pbos} PBOs | {status} |\n")
        
        f.write("\n## ðŸŒ Workshop Synchronization\n")
        f.write("| Mod Name | Project | Locked | Live | Status |\n")
        f.write("| :--- | :--- | :--- | :--- | :--- |\n")
        updates_needed = 0
        for m in ws_data:
            status = "âœ… Current" if m['up_to_date'] else "âŒ Update Available"
            if not m['up_to_date']: updates_needed += 1
            f.write(f"| {m['name']} | {m['project']} | `{m['locked']}` | `{m['live']}` | {status} |\n")

        f.write("\n## ðŸ› ï¸ Required Actions\n")
        if updates_needed > 0:
            f.write(f"- [ ] **Workshop**: {updates_needed} mods are out of date. Run `./tools/workspace_manager.py apply-updates`.\n")
        
        for p in dash_data:
            if p['sync_state'] != "OK":
                f.write(f"- [ ] **Project**: {p['project']} requires a local mod sync. Run `./tools/workspace_manager.py sync` inside the project.\n")
        
        if updates_needed == 0 and all(p['sync_state'] == "OK" for p in dash_data):
            f.write("- âœ… All systems nominal. No immediate actions required.\n")

        f.write("\n---\n*Generated by UKSFTA Platinum DevOps Suite*")

    print(f"âœ… Report saved to: {report_path}")

if __name__ == "__main__":
    generate_report(Path(__file__).parent.parent)
